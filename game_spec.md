## テトリスゲーム (Rust CLI) - 開発仕様書

### 1. プロジェクト概要

Rust言語と`crossterm`ライブラリを使用して開発された、ターミナル上で動作するテトリスゲーム。標準的なテトリスの要素に加え、独自のブロック消去ルール、スコア計算、および重力システムを特徴とする。

### 2. コアゲームメカニクス

*   **盤面サイズ:** 幅10マス x 高さ20マス。
*   **テトリミノ:** 標準的な7種類のテトリミノ（I, O, T, L, J, S, Z）を使用。
*   **基本操作:**
    *   左右移動 (`←`, `→` キー)
    *   時計回り回転 (`↓` キー)
    *   半時計回り回転 (`↑` キー)
    *   ソフトドロップ (`Space` キー)
    *   ハードドロップ (`Shift` + `↓` キー)
*   **ゲームオーバー:** ブロックが盤面上部に積み上がるとゲームオーバー。
*   **ゲームサイクル** タイトル画面→ゲームプレイ→ゲームオーバー→タイトル画面。

### 3. 視覚表現とUI

*   **ブロック表現:** 各ブロックは `[]` で表現され、前景色で色付けされる。
*   **テトリミノの色:**
    *   使用色はシアン、マゼンタ、イエローの3色のみ。
    *   各テトリミノは4つのブロックで構成され、出現時にこれら3色からランダムに割り当てられる（1つのテトリミノ内で4つのブロックは異なる色を持ち、かつ隣接するブロックは異なる色を持つ）。
    *   回転時もブロックの色は固定され、位置に応じて色が入れ替わる。
*   **壁の色:** 盤面の枠線は灰色で表示され、ブロックと区別しやすい。
*   **落下位置予測 (ゴースト):**
    *   現在落下中のテトリミノの最終着地点が `::` の文字で表示される。
    *   ゴーストの色は、その位置に着地するブロックの色と同じ。
*   **ライン消去アニメーション:**
    *   アニメーション中のブロックは、元の色を反転させた色で表示される。
    *   アニメーション速度は1ステップあたり120ミリ秒。
*   **UI表示:**
    *   スコア、コンボ数が盤面右側に表示される。
    *   操作説明が表示される。

### 4.  (カスタム)

*   **ミノの着地時の盤面の変化**
    1. ブロックが着地するたびに固定ブロックがスキャンされ、上下左右に同じ色が隣接している場合はブロックが数字に変化する。
    2. 数字は、そのブロックが同色のブロックと何個連結しているかを表す数
    3. 数字はバックグラウンドがそのブロックの色で文字色は黒

*   **ライン消去後の演出と得点計算:** ラインが揃ったとき、以下のような演出が行われる
    1. 揃ったすべてのラインのブロックが点滅する
    2. 揃ったラインが最下段でない場合
        1. 揃ったラインよりも下にあるブロックを調べる
        2. 上下左右に同じ色がない（つまり数字に変化していない）ブロックが消える（無得点）
    3. 揃ったすべてのラインのブロックが灰色になる
    4. 灰色になったラインは、互いの間隔を保ったまま、残っているブロックを1段ずつ消しながら一番下のSolidラインの上に下がっていくアニメーションを行う
    5. 下がっていくラインはSolidラインに着地すると停止する。複数のラインが間を開けて下がっていくとき、下のラインが停止しても上のラインは下がり続けて間隔が詰まり、最後には下がりきったラインがすべて隣接する。
    6. 消される数字ブロックごとにスコアが加算される。スコアはブロックの数字×10pt
    7. 灰色のラインが一番したの段に達したらSolidのままで残り、フィールドの高さがそのラインの数だけ減る
    8. 次のラインが落下するときは底辺のSolidラインの上に積み重なり、フィールドがまたSolidラインの数だけ減る
    9. フィールドがどんどん浅くなり、フィールドがすべて埋まったらゲームオーバー


### 5. 技術的詳細と実装ノート

*   **言語:** Rust
*   **ターミナル操作ライブラリ:** `crossterm`
*   **入力ハンドリング:**
    *   ノンブロッキング入力。
    *   先行入力を受け付けて移動・回転のタイミングで反映する。
*   **描画:**
    *   `prev_state`と`state`を比較し、差分のみを描画する方式（ちらつき防止）。
    *   アニメーション終了後の画面クリーンアップを明示的に行う。
*   **テスト:**
    *   `src/tests/` ディレクトリ内にユニットテストを実装。
    *   `#[cfg(test)]` 属性を使用し、`board_logic_tests.rs`, `game_state_tests.rs`, `rotation_tests.rs` のように機能ごとにモジュールを分けてテストを記述。
    *   `cargo test` コマンドで実行。


### 6. 開発の方針

*    開発時の対話は日本語で行う
*    TDDのred-green-refactorのサイクルで開発する
*    cargo testでテストを実施する
*    cargo clippyとcargo fmtでコードの品質を担保する
*    TDDの1サイクルが終わるたびにcargo check, cargo test, cargo clipply, cargo fmtを実行してからgit add, commitする
*    non tracking fileをgit addする場合は理由を説明する
*    コミット前に`game_spec.md`のTDD計画を更新して、完了したタスクにチェックを入れる
*    改行を含むコミットメッセージはコマンドラインで失敗しやすいので一時ファイル経由で登録する
*    コミットメッセージは日本語で記載する
*    ソースコードを修正したときだけcargoコマンドで検査を行う
*    TDDのRefactorではRed/Greenで追加したテストを削除しない
*    コードを変更しようとする場合は必ず内容を説明する
*    コンパイルエラーが起きたときや、テストが意図せぬ失敗のときは一つ修正するたびにcargo testを実行して解決したか確認する。

---

### バグリスト

*    [ ]

---

### 改善点リスト

*   ミノの回転をスーパーローテーションシステム（SRS）に対応させたい
    *     その際、色がずれないようにテストを厳重にしたい

---

### 全体的なコードベースのリファクタリング計画 - 優先順位付け

**目的:** コードの可読性、保守性、拡張性を向上させ、将来の機能追加や変更を容易にする。安全でシンプルな変更から着手し、リスクを最小限に抑える。

**優先順位:**

**1. `Animation` enum の `count` フィールドのセマンティクス**
    *   **理由:** `Animation::LineBlink` の `count` フィールドの意図を明確にし、コードの可読性を向上させます。構造変更を伴うため、影響範囲は中程度です。
    *   **リファクタリング案:** `Animation::LineBlink` に `is_on: bool` のようなより明確なフィールドを追加し、その変更が影響する箇所（アニメーション処理ロジック）を更新する。
    *   **評価:** 危険性: 中。

**2. `GameState` の `is_valid_position` メソッドの改善**
    *   **理由:** ゲームのコアロジックに深く関わるため、最も慎重な変更が必要です。このメソッドの変更は、ゲームの動作に直接的な影響を与える可能性があります。
    *   **リファクタリング案:** ロジックを整理し、境界チェックと衝突チェックを別々のプライベートヘルパー関数に分割する。
    *   **評価:** 危険性: 中。

---

### TDD計画: ミノの回転をスーパーローテーションシステム（SRS）に対応させる (改訂版)

**目的:** テトリミノの回転をスーパーローテーションシステム（SRS）に準拠させ、より正確で標準的なゲームプレイを実現する。同時に、回転時のブロックの色の整合性を厳密に保証する。

**フェーズ1: Tetromino構造体の更新と回転状態の管理 (完了済み)**

**フェーズ2: SRS対応のためのデータ構造の導入と `SHAPES` の再定義**

1.  **Red (2.1):** SRSの回転をサポートするために、`Tetromino` 構造体または関連するデータ構造に、各テトリミノの各回転状態におけるブロックの相対座標と、回転中心のオフセットを保持できるような新しいデータ構造を導入する。
    *   **テスト:** 新しいデータ構造がSRSの仕様（例: テトリスガイドライン）に基づいて、Iミノ、Oミノ、Tミノ、Lミノ、Jミノ、Sミノ、Zミノの各回転状態におけるブロックの相対座標と回転中心のオフセットを正しく保持していることを確認するテストを追加する。
2.  **Green (2.2):** 上記の新しいデータ構造を実装し、`Tetromino::SHAPES` をこの新しいデータ構造に置き換える。`Tetromino::from_shape()` メソッドが新しいデータ構造からブロック位置と回転中心のオフセットを正しく読み込むように変更する。テストがパスすることを確認する。
    *   **Red (2.2.1):** `Tetromino::from_shape()` メソッドが `SRS_SHAPES` からブロック位置を読み込むように変更する準備として、`Tetromino::from_shape()` が `SRS_SHAPES` を参照するように変更し、コンパイルエラーを発生させる。
        *   **テスト:** (コンパイルエラーがテストの代わり)
    *   **Green (2.2.2):** `Tetromino::from_shape()` メソッドを修正し、`SRS_SHAPES` からブロック位置を正しく読み込むようにする。これにより、コンパイルエラーを解消し、既存のテストがパスするようにする。
        *   **Red (2.2.2.1):** `SRS_SHAPES` のIミノのRotation 2のデータがまだ仮の値であることに対して、SRSの正しい値を期待するテストを追加する。
            *   **テスト:** `test_srs_shapes_i_mino_rotation_2_blocks()` と `test_srs_shapes_i_mino_rotation_2_offset()` を追加し、失敗することを確認する。
        *   **Green (2.2.2.2):** `SRS_SHAPES` のIミノのRotation 2のデータをSRSの仕様に基づいて修正し、テストがパスするようにする。
            *   **テスト:** 既存のすべてのテストがパスすることを確認する。
        *   **Red (2.2.2.3):** `SRS_SHAPES` のIミノのRotation 3のデータがまだ仮の値であることに対して、SRSの正しい値を期待するテストを追加する。
            *   **テスト:** `test_srs_shapes_i_mino_rotation_3_blocks()` と `test_srs_shapes_i_mino_rotation_3_offset()` を追加し、失敗することを確認する。
        *   **Green (2.2.2.4):** `SRS_SHAPES` のIミノのRotation 3のデータをSRSの仕様に基づいて修正し、テストがパスするようにする。
            *   **テスト:** 既存のすべてのテストがパスすることを確認する。
        *   **Red (2.2.2.5):** `SRS_SHAPES` のOミノのRotation 0のデータがまだ仮の値であることに対して、SRSの正しい値を期待するテストを追加する。
            *   **テスト:** `test_srs_shapes_o_mino_rotation_0_blocks()` と `test_srs_shapes_o_mino_rotation_0_offset()` を追加し、失敗することを確認する。
        *   **Green (2.2.2.6):** `SRS_SHAPES` のOミノのRotation 0のデータをSRSの仕様に基づいて修正し、テストがパスするようにする。
            *   **テスト:** 既存のすべてのテストがパスすることを確認する。
        *   **Red (2.2.2.7):** `SRS_SHAPES` のOミノのRotation 1のデータがまだ仮の値であることに対して、SRSの正しい値を期待するテストを追加する。
            *   **テスト:** `test_srs_shapes_o_mino_rotation_1_blocks()` と `test_srs_shapes_o_mino_rotation_1_offset()` を追加し、失敗することを確認する。
        *   **Green (2.2.2.8):** `SRS_SHAPES` のOミノのRotation 1のデータをSRSの仕様に基づいて修正し、テストがパスするようにする。
            *   **テスト:** 既存のすべてのテストがパスすることを確認する。
        *   **Red (2.2.2.9):** `SRS_SHAPES` のOミノのRotation 2のデータがまだ仮の値であることに対して、SRSの正しい値を期待するテストを追加する。
            *   **テスト:** `test_srs_shapes_o_mino_rotation_2_blocks()` と `test_srs_shapes_o_mino_rotation_2_offset()` を追加し、失敗することを確認する。
        *   **Green (2.2.2.10):** `SRS_SHAPES` のOミノのRotation 2のデータをSRSの仕様に基づいて修正し、テストがパスするようにする。
            *   **テスト:** 既存のすべてのテストがパスすることを確認する。
        *   **Red (2.2.2.11):** `SRS_SHAPES` のOミノのRotation 3のデータがまだ仮の値であることに対して、SRSの正しい値を期待するテストを追加する。
            *   **テスト:** `test_srs_shapes_o_mino_rotation_3_blocks()` と `test_srs_shapes_o_mino_rotation_3_offset()` を追加し、失敗することを確認する。
        *   [x] **Green (2.2.2.12):** `SRS_SHAPES` のOミノのRotation 3のデータをSRSの仕様に基づいて修正し、テストがパスするようにする。
            *   **テスト:** 既存のすべてのテストがパスすることを確認する。
        *   [x] **Red (2.2.2.13):** `SRS_SHAPES` のTミノのRotation 0のデータがまだ仮の値であることに対して、SRSの正しい値を期待するテストを追加する。
            *   **テスト:** `test_srs_shapes_t_mino_rotation_0_blocks()` と `test_srs_shapes_t_mino_rotation_0_offset()` を追加し、失敗することを確認する。
        *   [x] **Green (2.2.2.14):** `SRS_SHAPES` のTミノのRotation 0のデータをSRSの仕様に基づいて修正し、テストがパスするようにする。
            *   **テスト:** 既存のすべてのテストがパスすることを確認する。
        *   ... (Tミノの残りの回転状態)
        *   **Tミノ**
            *   [x] Red (2.2.2.15): Tミノ Rotation 1 のテストを追加
            *   [x] Green (2.2.2.16): Tミノ Rotation 1 のデータを修正
            *   [x] Red (2.2.2.17): Tミノ Rotation 2 のテストを追加
            *   [x] Green (2.2.2.18): Tミノ Rotation 2 のデータを修正
            *   [ ] Red (2.2.2.19): Tミノ Rotation 3 のテストを追加
            *   [ ] Green (2.2.2.20): Tミノ Rotation 3 のデータを修正
        *   **Lミノ**
            *   [ ] Red (2.2.2.21): Lミノ Rotation 0 のテストを追加
            *   [ ] Green (2.2.2.22): Lミノ Rotation 0 のデータを修正
            *   [ ] Red (2.2.2.23): Lミノ Rotation 1 のテストを追加
            *   [ ] Green (2.2.2.24): Lミノ Rotation 1 のデータを修正
            *   [ ] Red (2.2.2.25): Lミノ Rotation 2 のテストを追加
            *   [ ] Green (2.2.2.26): Lミノ Rotation 2 のデータを修正
            *   [ ] Red (2.2.2.27): Lミノ Rotation 3 のテストを追加
            *   [ ] Green (2.2.2.28): Lミノ Rotation 3 のデータを修正
        *   **Jミノ**
            *   [ ] Red (2.2.2.29): Jミノ Rotation 0 のテストを追加
            *   [ ] Green (2.2.2.30): Jミノ Rotation 0 のデータを修正
            *   [ ] Red (2.2.2.31): Jミノ Rotation 1 のテストを追加
            *   [ ] Green (2.2.2.32): Jミノ Rotation 1 のデータを修正
            *   [ ] Red (2.2.2.33): Jミノ Rotation 2 のテストを追加
            *   [ ] Green (2.2.2.34): Jミノ Rotation 2 のデータを修正
            *   [ ] Red (2.2.2.35): Jミノ Rotation 3 のテストを追加
            *   [ ] Green (2.2.2.36): Jミノ Rotation 3 のデータを修正
        *   **Sミノ**
            *   [ ] Red (2.2.2.37): Sミノ Rotation 0 のテストを追加
            *   [ ] Green (2.2.2.38): Sミノ Rotation 0 のデータを修正
            *   [ ] Red (2.2.2.39): Sミノ Rotation 1 のテストを追加
            *   [ ] Green (2.2.2.40): Sミノ Rotation 1 のデータを修正
            *   [ ] Red (2.2.2.41): Sミノ Rotation 2 のテストを追加
            *   [ ] Green (2.2.2.42): Sミノ Rotation 2 のデータを修正
            *   [ ] Red (2.2.2.43): Sミノ Rotation 3 のテストを追加
            *   [ ] Green (2.2.2.44): Sミノ Rotation 3 のデータを修正
        *   **Zミノ**
            *   [ ] Red (2.2.2.45): Zミノ Rotation 0 のテストを追加
            *   [ ] Green (2.2.2.46): Zミノ Rotation 0 のデータを修正
            *   [ ] Red (2.2.2.47): Zミノ Rotation 1 のテストを追加
            *   [ ] Green (2.2.2.48): Zミノ Rotation 1 のデータを修正
            *   [ ] Red (2.2.2.49): Zミノ Rotation 2 のテストを追加
            *   [ ] Green (2.2.2.50): Zミノ Rotation 2 のデータを修正
            *   [ ] Red (2.2.2.51): Zミノ Rotation 3 のテストを追加
            *   [ ] Green (2.2.2.52): Zミノ Rotation 3 のデータを修正
3.  **Refactor (2.3):** コードの可読性を向上させる。特に、新しいデータ構造の命名と利用方法が明確であることを確認する。

**フェーズ3: SRSウォールキックデータの定義**

1.  **Red (3.1):** SRSのウォールキックデータ（JLSZTとIミノ用）を定数として定義する。これは`src/tetromino.rs`内、または新しい`src/srs.rs`モジュールに配置する。
    *   **テスト:** 定義されたウォールキックデータが、SRSの仕様（例: テトリスガイドライン）と一致していることを確認する静的なテスト（例: 特定のインデックスのデータが期待値と一致するか）を追加。
2.  **Green (3.2):** ウォールキックデータを実装し、テストがパスすることを確認する。
3.  **Refactor (3.3):** ウォールキックデータの構造が、後続のウォールキック適用ロジックで使いやすいように最適化されているか確認する。

**フェーズ4: SRS回転ロジックの実装と色の整合性**

1.  **Red (4.1):** `Tetromino::rotated()`および`Tetromino::rotated_counter_clockwise()`メソッドを、SRSの回転ロジック（回転中心を基準とした座標変換とウォールキックの適用）に基づいて再実装する。この際、ブロックの色のマッピングは考慮しない（既存の色をそのまま引き継ぐか、一時的に無視する）。
    *   **テスト:** 各テトリミノ（Oミノを除く）について、初期状態から時計回り・反時計回りに回転させ、4つの回転状態すべてでブロックの相対位置がSRSの仕様に準拠していることを確認するテストを追加。特に、壁際での回転がウォールキックによって正しく成功するシナリオや、ウォールキックでも回転が不可能なシナリオで回転が拒否されることを確認する統合テストを追加。
2.  **Green (4.2):** 上記の変更を実装し、テストがパスすることを確認する。
3.  **Refactor (4.3):** コードの可読性を向上させる。

**フェーズ5: 回転時のブロック色の整合性保証**

1.  **Red (5.1):** `Tetromino::rotated()`および`Tetromino::rotated_counter_clockwise()`メソッドにおいて、回転後のブロック位置と元のブロックの色の対応関係を正しく維持するロジックを実装する。この際、Oミノの特殊な色回転はまだ考慮しない。
    *   **テスト:** 各テトリミノ（Oミノを除く）について、初期状態から時計回り・反時計回りに回転させ、4つの回転状態すべてでブロックの相対位置が正しいことを確認するテストに加え、**回転前後で各ブロックの色がずれていないこと**を厳密に検証するテストを追加。
2.  **Green (5.2):** 上記の変更を実装し、テストがパスすることを確認する。
3.  **Refactor (5.3):** コードの可読性を向上させる。

**フェーズ6: Oミノの特殊な色回転の統合**

1.  **Red (6.1):** `Tetromino::rotated()`および`Tetromino::rotated_counter_clockwise()`メソッドにおいて、Oミノの特殊な色回転ロジックを、新しいSRSベースのロジックと統合し、正しく機能するように修正する。
    *   **テスト:** Oミノについて、時計回り・反時計回りに回転させ、4つの回転状態すべてでブロックの相対位置と色が正しく回転していることを厳密に検証するテストを追加。
2.  **Green (6.2):** 上記の変更を実装し、テストがパスすることを確認する。
3.  **Refactor (6.3):** コードの可読性を向上させる。

**フェーズ7: `GameState::is_valid_position`のリファクタリング (既存のフェーズ4)**

1.  **Red (7.1):** `GameState::is_valid_position`メソッドを、境界チェックとブロック衝突チェックの2つのプライベートヘルパー関数に分割する。
    *   **テスト:** 分割された各ヘルパー関数が、元の`is_valid_position`と同じロジックで正しく機能することを確認するユニットテストを追加。
2.  **Green (7.2):** 上記の変更を実装し、テストがパスすることを確認する。
3.  **Refactor (7.3):** 分割された関数名が意図を明確に表しているか、コードの可読性が向上したかを確認する。

---

### 完了したタスク

*   [x] TDD計画を`game_spec.md`に追加した。
*   [x] TDD計画: フェーズ1 Red (1.1) - Tetromino構造体の更新と回転状態の管理
*   [x] TDD計画: フェーズ1 Green (1.2) - 上記の変更を実装し、テストがパスすることを確認
*   [x] TDD計画: フェーズ1 Refactor (1.3) - `Tetromino::SHAPES`の定義がSRSの回転状態と一致しているか確認し、必要であれば修正する。特に、Iミノの回転中心が正しく設定されているか確認する。
*   [x] TDD計画: フェーズ2 Red (2.1) - SRS対応のためのデータ構造の導入と `SHAPES` の再定義 (Iミノ Rotation 0, 1 のテスト追加)
*   [x] TDD計画: フェーズ2 Green (2.2) - SRS対応のためのデータ構造の導入と `SHAPES` の再定義 (Iミノ Rotation 0, 1 のデータ修正)
