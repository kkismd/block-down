## テトリスゲーム (Rust CLI) - 開発仕様書

### 1. プロジェクト概要

Rust言語と`crossterm`ライブラリを使用して開発された、ターミナル上で動作するテトリスゲーム。標準的なテトリスの要素に加え、独自のブロック消去ルール、スコア計算、および重力システムを特徴とする。

### 2. コアゲームメカニクス

*   **盤面サイズ:** 幅10マス x 高さ20マス。
*   **テトリミノ:** 標準的な7種類のテトリミノ（I, O, T, L, J, S, Z）を使用。
*   **基本操作:**
    *   左右移動 (`←`, `→` キー)
    *   ソフトドロップ (`↓` キー)
    *   ハードドロップ (`↑` キー)
    *   回転 (`Space` キー)
*   **ゲームオーバー:** ブロックが盤面上部に積み上がるとゲームオーバー。

### 3. 視覚表現とUI

*   **ブロック表現:** 各ブロックは `[]` で表現され、前景色で色付けされる。
*   **テトリミノの色:**
    *   使用色はシアン、マゼンタ、イエロー、グリーンの4色のみ。
    *   各テトリミノは4つのブロックで構成され、出現時にこれら4色がランダムに割り当てられる（1つのテトリミノ内で4つのブロックは異なる色を持つ）。
    *   回転時もブロックの色は固定され、位置に応じて色が入れ替わる。
*   **壁の色:** 盤面の枠線は灰色で表示され、ブロックと区別しやすい。
*   **落下位置予測 (ゴースト):**
    *   現在落下中のテトリミノの最終着地点が `vv` の文字で表示される。
    *   ゴーストの色は、その位置に着地するブロックの色と同じ。
*   **ライン消去アニメーション:**
    *   ブロックが消える際、`[]` `()` `{}` `<>` `{}` `()` `[]` の文字が順番に表示されるアニメーションが3回繰り返される（合計21ステップ）。
    *   アニメーション中のブロックは、元の色を反転させた色で表示される。
    *   アニメーション速度は1ステップあたり120ミリ秒。
*   **UI表示:**
    *   スコア、コンボ数が盤面右側に表示される。
    *   操作説明が表示される。

### 4. スコアリングシステム (カスタム)

*   **基本計算:** 1回の消去で消えたブロックの合計数を `N` 個とする。
    *   得点 = `(2のN乗) × 100点`
    *   `N` の値は、`u64`型のオーバーフローを防ぐため、最大50に制限される。
*   **コンボ:**
    *   連続してブロックが消去されるとコンボが発生し、コンボ数に応じてスコアに倍率がかかる。
    *   得点 = `(2のN乗) × 100点 × コンボ数`
    *   コンボが途切れるとリセットされる。

### 5. 消去ロジックと重力システム (カスタム)

*   **消去トリガー:** 横一列にブロックが揃うと消去が開始される。
*   **連鎖消去:**
    *   ラインが揃って消去が開始されると、そのライン上のブロックに隣接（上下左右）する**同じ色のブロック**も連鎖的に消去される。
    *   この連鎖は、繋がるブロックがなくなるまで続く。
*   **重力システム (カスタム):**
    *   ブロックが消去された後、**消去されたブロックがあった列のみ**が落下処理の対象となる。
    *   対象列内では、**消去されたブロックよりも上にあったブロックだけ**が、その列で消えたブロックの数だけ下にスライドして詰まる。
    *   消去されたブロックよりも下にあったブロックや、ブロックが消されなかった列のブロックは、たとえ下に空間があっても**一切落下しない**。

### 6. 技術的詳細と実装ノート

*   **言語:** Rust
*   **ターミナル操作ライブラリ:** `crossterm`
*   **入力ハンドリング:**
    *   ノンブロッキング入力。
    *   キーの「押し始め」イベント (`KeyEventKind::Press`) のみを受け付け、OSによるオートリピートは無視される。
    *   毎フレーム、最後に押されたキーのみが処理される。
*   **描画:**
    *   `prev_state`と`state`を比較し、差分のみを描画する方式（ちらつき防止）。
    *   アニメーション終了後の画面クリーンアップを明示的に行う。
*   **テスト:**
    *   `#[cfg(test)]`モジュール内にユニットテストを実装。
    *   `find_clearable_blocks` (色の繋がり探索)
    *   `apply_gravity_collapse` (落下ロジック)
    *   `Tetromino::rotated` (回転の形と色)
    *   スコア計算
    *   `is_valid_position` (境界と衝突判定)

---
