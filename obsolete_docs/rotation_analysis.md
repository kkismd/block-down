# 現在の回転システム分析レポート

## 🔍 現在の実装状況

### 1. 回転メソッド
- `rotated()` - 時計回り回転
- `rotated_counter_clockwise()` - 反時計回り回転

### 2. テトリミノ別の回転実装

#### I-ミノ
- **回転中心**: 2番目のブロック（インデックス1）
- **方式**: 特別処理（pivot_block_index = 1）
- **問題**: SRSでは異なる回転中心が必要

#### O-ミノ  
- **回転中心**: 形状変化なし
- **方式**: 色のローテーションのみ
- **色パターン**: [0,1,2,3] → [2,0,3,1] (時計回り)
- **問題**: SRSでも同様だが、位置調整が必要な場合あり

#### T, L, J, S, Z-ミノ
- **回転中心**: 原点(0,0)周り
- **方式**: 単純な座標変換 `(x,y) -> (-y,x)` または `(x,y) -> (y,-x)`
- **問題**: SRSでは(1,1)を中心とした回転が必要

### 3. 色ローテーション
- **O-ミノ**: 特別な色ローテーション配列で管理
- **他のミノ**: 色情報が座標と一緒に自然に回転
- **利点**: 現在の実装で色の一貫性は保たれている

### 4. 衝突判定
- `is_valid_position()` で回転後位置をチェック
- **問題**: Wall Kick（壁蹴り）機能が未実装

### 5. 既存テストの品質
- **全7種のミノ**: 完全な回転サイクルテストあり
- **色の検証**: 各回転状態で色位置を厳密にチェック
- **再利用性**: `assert_piece_state`関数でテスト構造が統一
- **利点**: SRS移行時にテスト構造を流用可能

## 🎯 SRSとの主な差異

### 1. 回転中心の違い
| ミノ | 現在 | SRS標準 |
|------|------|---------|
| I | 2番目ブロック | グリッド中心 |
| O | 変化なし | 微調整あり |
| T,L,J,S,Z | (0,0)中心 | (1,1)中心 |

### 2. Wall Kick未実装
- **現在**: 回転できない場合は回転しない
- **SRS**: 複数のオフセット試行で回転を試みる
- **必要**: 5段階のwall kickテーブル

### 3. 回転状態管理なし
- **現在**: 形状のみで判断
- **SRS**: 0,1,2,3の回転状態を明示的に管理
- **必要**: 回転状態フィールドの追加

### 4. オフセットデータ未実装
- **現在**: 基本形状のみ
- **SRS**: 各回転状態に対応する位置オフセット
- **必要**: テトリミノ別×回転状態別のオフセットテーブル

## 📋 SRS実装で必要な要素

### ✅ 保持できる要素
1. **色ローテーション**: 現在の実装が十分
2. **テスト構造**: 既存のテストフレームワークを流用
3. **基本形状データ**: SHAPES定数を拡張利用

### 🔧 実装が必要な要素
1. **回転状態管理**: `rotation_state: u8` (0,1,2,3)
2. **正しい回転中心**: SRS準拠の中心点
3. **Wall Kickシステム**: オフセットテーブル + 試行ロジック
4. **SRS準拠の座標系**: 標準的なSRSグリッド

## 🚀 実装戦略

### Phase 1: 回転状態管理
- Tetrominoに`rotation_state`フィールド追加
- 回転時に状態を更新

### Phase 2: SRS回転中心
- 各テトリミノのSRS標準回転中心に修正
- 既存テストを新仕様で更新

### Phase 3: Wall Kickシステム
- SRSオフセットテーブル実装
- Wall kick試行ロジック追加

### Phase 4: 統合テスト
- 色の一貫性検証
- 既存機能の回帰テスト